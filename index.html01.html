<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AQuiz Maths - Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: radial-gradient(circle at top, #1e1b4b 0%, #020617 100%);
            --card: rgba(255, 255, 255, 0.05);
            --text: #ffffff;
            --border: rgba(255, 255, 255, 0.12);
            --teal: #2dd4bf;
            --primary: #6366f1;
            --danger: #f43f5e; --warning: #f59e0b; --success: #10b981;
            --opt1: #38bdf8; --opt2: #fb7185; --opt3: #c084fc; --opt4: #fbbf24;
        }

        [data-theme="light"] {
            --bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --card: #ffffff;
            --text: #0f172a;
            --border: rgba(0, 0, 0, 0.1);
            --teal: #0d9488;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Poppins', sans-serif; transition: background 0.3s ease, color 0.3s ease; }
        body { background: #000; margin: 0; display: flex; justify-content: center; align-items: center; height: 100dvh; overflow: hidden; }

        .app-viewport {
            width: 100vw; height: 100dvh; max-width: 500px;
            background: var(--bg); position: relative; overflow: hidden;
            display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        .page { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; transition: 0.5s ease; z-index: 10; }
        .hidden { opacity: 0; visibility: hidden; pointer-events: none; transform: scale(0.95); }

        .app-icon {
            width: 100px; height: 100px; background: linear-gradient(135deg, var(--primary), var(--teal));
            border-radius: 24px; display: flex; align-items: center; justify-content: center;
            font-size: 3.5rem; font-weight: 800; color: white; margin-bottom: 20px;
        }

        .btn-premium {
            width: 100%; padding: 18px; border-radius: 16px; border: none;
            background: linear-gradient(135deg, var(--primary), var(--teal));
            color: #fff; font-weight: 800; font-size: 1.1rem; cursor: pointer;
            text-transform: uppercase; box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .hud { width: 100%; display: flex; justify-content: space-between; align-items: center; position: absolute; top: 40px; padding: 0 30px; color: var(--text); z-index: 20; }
        .equation { font-size: 2.8rem; font-weight: 800; color: var(--text); margin-bottom: 30px; text-align: center; }
        .ans-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; }
        .ans-btn { padding: 25px; border-radius: 20px; border: 2px solid var(--border); color: var(--text); font-size: 1.8rem; font-weight: 800; cursor: pointer; background: var(--card); }

        .track { width: 100%; height: 8px; background: rgba(128,128,128,0.2); border-radius: 10px; overflow: hidden; }
        .fill { height: 100%; width: 0%; background: var(--teal); box-shadow: 0 0 15px var(--teal); transition: width 0.1s linear; }

        .settings-overlay { position: absolute; inset: 0; background: var(--bg); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 15px; padding: 40px; }
        .setting-row { width: 100%; display: flex; justify-content: space-between; align-items: center; color: var(--text); font-weight: 600; }
        .toggle-btn { width: 90px; padding: 8px; border-radius: 10px; border: 2px solid var(--teal); background: transparent; color: var(--text); font-weight: 800; cursor: pointer; }
        .toggle-btn.on { background: var(--teal); color: #000; }

        .back-link { color: var(--teal); cursor: pointer; margin-top: 25px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; font-size: 0.9rem; }
        .shake { animation: shake 0.4s ease; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-10px); } 75% { transform: translateX(10px); } }
    </style>
</head>
<body data-theme="dark">

<div class="app-viewport" id="viewport">
    
    <div id="page-brand" class="page">
        <div class="app-icon">A</div>
        <h1 style="color: var(--text); letter-spacing: 3px; margin: 0; font-size: 2.2rem;">AQUIZ MATHS</h1>
    </div>

    <div id="page-loading" class="page hidden">
        <p style="color: var(--text); font-weight: 800; letter-spacing: 4px; margin-bottom: 15px;">LOADING</p>
        <div class="track" style="width:70%"><div class="fill" id="load-fill"></div></div>
        <p id="load-pc" style="color: var(--teal); font-weight: 800; font-size: 1.5rem; margin-top: 15px;">0%</p>
    </div>

    <div id="page-start" class="page hidden">
        <div style="color: var(--text); font-size: 1.4rem; font-weight: 600; margin-bottom: 20px; text-align: center;">Ready to Solve?</div>
        <button class="btn-premium" style="width: 180px; height: 180px; border-radius: 50%; font-size: 1.5rem;" onclick="initSystem()">START</button>
    </div>

    <div id="page-diff" class="page hidden">
        <h2 style="color: var(--text); margin-bottom: 30px;">CHOOSE LEVEL</h2>
        <div style="width: 100%; display: flex; flex-direction: column; gap: 20px;">
            <button class="btn-premium" style="background: var(--success); height: 100px; font-size: 1.5rem;" onclick="navTo('modes-normal')">NORMAL</button>
            <button class="btn-premium" style="background: var(--primary); height: 100px; font-size: 1.5rem;" onclick="navTo('modes-standard')">STANDARD</button>
        </div>
        <p class="back-link" onclick="navTo('start')">← BACK</p>
    </div>

    <div id="page-modes-normal" class="page hidden">
        <h2 style="color: var(--text);">NORMAL MODES</h2>
        <div style="width: 100%; display: flex; flex-direction: column; gap: 12px;">
            <button class="btn-premium" style="background: var(--success)" onclick="prepareGame('ADD')">ADDITION</button>
            <button class="btn-premium" style="background: var(--warning)" onclick="prepareGame('SUB')">SUBTRACTION</button>
            <button class="btn-premium" style="background: #3b82f6" onclick="prepareGame('MUL')">MULTIPLICATION</button>
            <button class="btn-premium" style="background: #8b5cf6" onclick="prepareGame('DIV')">DIVISION</button>
            <button class="btn-premium" style="background: var(--danger)" onclick="prepareGame('ALL')">ALL MODE</button>
        </div>
        <p class="back-link" onclick="navTo('diff')">← BACK</p>
    </div>

    <div id="page-modes-standard" class="page hidden">
        <h2 style="color: var(--text);">STANDARD BODMAS</h2>
        <div style="width: 100%; display: flex; flex-direction: column; gap: 12px;">
            <button class="btn-premium" style="background: #0ea5e9" onclick="prepareGame('S1')">ADD + SUB</button>
            <button class="btn-premium" style="background: #f43f5e" onclick="prepareGame('S2')">ADD + SUB + MUL</button>
            <button class="btn-premium" style="background: #a855f7" onclick="prepareGame('S3')">FULL BODMAS</button>
        </div>
        <p class="back-link" onclick="navTo('diff')">← BACK</p>
    </div>

    <div id="page-game" class="page hidden">
        <div class="hud">
            <div id="score" style="font-size: 2rem; font-weight: 800; color: var(--teal);">0</div>
            <div id="hearts">❤️❤️❤️</div>
            <div style="font-size: 2rem; cursor: pointer;" onclick="toggleSettings(true)">⚙️</div>
        </div>
        <div class="equation" id="eqn">0 + 0</div>
        <div class="ans-grid" id="ans-grid"></div>
        <div class="track" style="margin-top: 40px;"><div class="fill" id="timer-bar" style="width: 100%;"></div></div>
        <p class="back-link" onclick="stopAndQuit('diff')">← BACK TO MENU</p>
    </div>

    <div id="settings-menu" class="settings-overlay hidden">
        <h2 style="color: var(--text);">SETTINGS</h2>
        <div class="setting-row"><span>THEME</span><button class="toggle-btn" id="btn-theme" onclick="toggleTheme()">DARK</button></div>
        <div class="setting-row"><span>SOUND</span><button class="toggle-btn on" id="btn-sound" onclick="updatePref('sound')">ON</button></div>
        <div class="setting-row"><span>VIBRATION</span><button class="toggle-btn on" id="btn-vib" onclick="updatePref('vib')">ON</button></div>
        <div class="setting-row"><span>MUSIC</span><button class="toggle-btn on" id="btn-music" onclick="updatePref('music')">ON</button></div>
        <button class="btn-premium" style="margin-top: 15px;" onclick="toggleSettings(false)">RESUME</button>
        <button class="btn-premium" style="background: #334155;" onclick="stopAndQuit('diff')">BACK TO MENU</button>
        <button class="btn-premium" style="background: #1e293b;" onclick="stopAndQuit('start')">EXIT GAME</button>
    </div>

    <div id="page-result" class="page hidden">
        <h1 id="res-title" style="font-size: 3rem;"></h1>
        <div style="background: var(--card); padding: 30px; border-radius: 20px; width: 100%; text-align: center; border: 1px solid var(--border);">
            <div id="f-score" style="color: var(--text); font-size: 4.5rem; font-weight: 800;">0</div>
            <p style="color: var(--teal); font-weight: 800;">BEST: <span id="best-score">0</span></p>
        </div>
        <button class="btn-premium" style="margin-top: 20px;" onclick="prepareGame(currentMode)">PLAY AGAIN</button>
        <button class="btn-premium" style="background: transparent; border: 1px solid var(--border); margin-top: 10px; color: var(--text);" onclick="navTo('diff')">MENU</button>
    </div>
</div>

<script>
    const AudioEngine = {
        ctx: null, masterGain: null, musicGain: null,
        init() {
            if (this.ctx) return;
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
            this.masterGain = this.ctx.createGain();
            this.musicGain = this.ctx.createGain();
            this.masterGain.connect(this.ctx.destination);
            this.musicGain.connect(this.ctx.destination);
            this.masterGain.gain.value = 1.0;
            this.musicGain.gain.value = 0.15;
            this.startBGM();
        },
        play(freq, type, duration, vol = 0.8) {
            if(!this.ctx || !prefs.sound) return;
            const osc = this.ctx.createOscillator();
            const g = this.ctx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            g.gain.setValueAtTime(vol, this.ctx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.0001, this.ctx.currentTime + duration);
            osc.connect(g).connect(this.masterGain);
            osc.start(); osc.stop(this.ctx.currentTime + duration);
        },
        startBGM() {
            const playNote = (note, time) => {
                if(!prefs.music) return;
                const osc = this.ctx.createOscillator();
                const g = this.ctx.createGain();
                osc.frequency.setValueAtTime(note, time);
                g.gain.setValueAtTime(0.05, time);
                g.gain.exponentialRampToValueAtTime(0.0001, time + 0.5);
                osc.connect(g).connect(this.musicGain);
                osc.start(time); osc.stop(time + 0.5);
            };
            let step = 0;
            setInterval(() => {
                if(this.ctx && prefs.music) {
                    const now = this.ctx.currentTime;
                    const notes = [110, 123, 130, 146];
                    playNote(notes[step % 4], now);
                    step++;
                }
            }, 600);
        }
    };

    let score = 0, lives = 3, timeLeft = 100, timer, currentMode = 'ADD', isPaused = false;
    let prefs = { sound: true, vib: true, music: true, theme: 'dark' };
    let bestScore = localStorage.getItem('aquiz_top') || 0;

    window.onload = () => { runLoading(15000, () => showPage('start')); };

    function initSystem() { AudioEngine.init(); navTo('diff'); }

    function navTo(pageId) {
        AudioEngine.play(800, 'sine', 0.1);
        runLoading(1000, () => showPage(pageId));
    }

    function runLoading(duration, callback) {
        const fill = document.getElementById('load-fill');
        const pc = document.getElementById('load-pc');
        showPage('loading');
        let start = Date.now();
        let interval = setInterval(() => {
            let elapsed = Date.now() - start;
            let progress = Math.min((elapsed / duration) * 100, 100);
            fill.style.width = progress + '%';
            pc.innerText = Math.floor(progress) + '%';
            if(progress >= 100) { clearInterval(interval); setTimeout(callback, 200); }
        }, 30);
    }

    function stopAndQuit(targetPage) {
        AudioEngine.play(400, 'sine', 0.1);
        clearInterval(timer); isPaused = false;
        toggleSettings(false); navTo(targetPage);
    }

    function prepareGame(mode) {
        currentMode = mode;
        AudioEngine.play(1000, 'sine', 0.1);
        runLoading(1200, () => start(mode));
    }

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
        document.getElementById(`page-${id}`).classList.remove('hidden');
    }

    function updatePref(type) {
        AudioEngine.play(900, 'sine', 0.1);
        prefs[type] = !prefs[type];
        let b = document.getElementById(`btn-${type}`);
        b.innerText = prefs[type] ? 'ON' : 'OFF';
        b.classList.toggle('on', prefs[type]);
    }

    function toggleTheme() {
        AudioEngine.play(1000, 'sine', 0.1);
        prefs.theme = prefs.theme === 'dark' ? 'light' : 'dark';
        document.body.setAttribute('data-theme', prefs.theme);
        document.getElementById('btn-theme').innerText = prefs.theme.toUpperCase();
    }

    function start(mode) {
        score = 0; lives = 3; isPaused = false;
        showPage('game'); nextQuestion();
    }

    function nextQuestion() {
        let q = generateEquation(currentMode);
        document.getElementById('eqn').innerText = q.text;
        document.getElementById('score').innerText = score;
        document.getElementById('hearts').innerText = "❤️".repeat(lives);

        let ans = q.ans;
        let opts = [ans, ans + 2, ans - 2, ans + 5].sort(() => Math.random() - 0.5);
        const grid = document.getElementById('ans-grid'); grid.innerHTML = '';
        const colors = ['var(--opt1)', 'var(--opt2)', 'var(--opt3)', 'var(--opt4)'];
        
        opts.forEach((o, i) => {
            let b = document.createElement('button');
            b.className = 'ans-btn'; b.innerText = o;
            b.style.borderColor = colors[i]; b.style.color = colors[i];
            b.onclick = () => { 
                if(o === ans) { 
                    score++; AudioEngine.play(1200, 'sine', 0.1); 
                    if(prefs.vib) navigator.vibrate(50);
                    nextQuestion(); 
                } else handleFail();
            };
            grid.appendChild(b);
        });
        resetTimer();
    }

    function generateEquation(m) {
        let n1 = Math.floor(Math.random()*15)+5, n2 = Math.floor(Math.random()*10)+2, n3 = Math.floor(Math.random()*5)+2;
        switch(m) {
            case 'ADD': return { text: `${n1} + ${n2}`, ans: n1 + n2 };
            case 'SUB': return { text: `${n1+n2} - ${n2}`, ans: n1 };
            case 'MUL': return { text: `${n1} × ${n2}`, ans: n1 * n2 };
            case 'DIV': return { text: `${n1*n2} ÷ ${n2}`, ans: n1 };
            case 'ALL': return generateEquation(['ADD','SUB','MUL','DIV'][Math.floor(Math.random()*4)]);
            case 'S1': return { text: `${n1} + ${n2} - ${n3}`, ans: n1 + n2 - n3 };
            case 'S2': return { text: `${n1} + ${n2} × ${n3}`, ans: n1 + (n2 * n3) };
            case 'S3': 
                let mult = n2 * n3;
                return { text: `${mult} ÷ ${n2} + ${n1} - ${n3}`, ans: (mult / n2) + n1 - n3 };
            default: return { text: "1 + 1", ans: 2 };
        }
    }

    function handleFail() {
        if(prefs.vib) navigator.vibrate([100, 50, 100]);
        lives--; AudioEngine.play(150, 'sawtooth', 0.4, 0.5);
        document.getElementById('viewport').classList.add('shake');
        setTimeout(() => document.getElementById('viewport').classList.remove('shake'), 400);
        if(lives <= 0) endGame("GAME OVER", "var(--danger)");
        else nextQuestion();
    }

    function resetTimer() {
        clearInterval(timer); timeLeft = 100;
        let speed = currentMode.startsWith('S') ? 0.8 : 1.5;
        timer = setInterval(() => {
            if(!isPaused) {
                timeLeft -= speed;
                document.getElementById('timer-bar').style.width = timeLeft + '%';
                if(timeLeft <= 0) handleFail();
            }
        }, 100);
    }

    function toggleSettings(show) { 
        AudioEngine.play(800, 'sine', 0.05);
        isPaused = show; document.getElementById('settings-menu').classList.toggle('hidden', !show); 
    }
    
    function endGame(t, c) {
        clearInterval(timer);
        if(score > bestScore) { bestScore = score; localStorage.setItem('aquiz_top', bestScore); }
        document.getElementById('res-title').innerText = t;
        document.getElementById('res-title').style.color = c;
        document.getElementById('f-score').innerText = score;
        document.getElementById('best-score').innerText = bestScore;
        showPage('result');
    }
</script>
</body>
</html>
